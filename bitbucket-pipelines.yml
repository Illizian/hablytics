image: lorisleiva/laravel-docker:7.3

definitions:
  steps:
    - step: &Install
        name: Install
        script:
          - npm install
          - composer install
        artifacts:
          - node_modules
          - vendor
    - step: &Build
        name: Build
        script:
          - npm run prod
        artifacts:
          - public
          - vendor
    - step: &Test
        name: Test
        script:
          - phpunit --coverage-text --colors=never
    - step: &Deploy
        name: Deploy [Unnamed]
        script:
          - ./deploy.sh
  caches:
    node: node_modules
    composer: vendor
    public: public

pipelines:
  default:
    - step: *Install
    - step: *Build
    - step: *Test
  branches:
    release/staging:
      - step: *Install
      - step: *Build
      - step:
        <<: *Deploy
        name: Deploy to Staging
        deployment: staging
    release/production:
      - step: *Install
      - step: *Build
      - step:
        <<: *Deploy
        name: Deploy to Production
        deployment: production
